---
title: Explore EWC - ALR
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE, 
                      cache = FALSE)
                      # TURN cache OFF)
```


Notes:

* I've just plotted basic lines here, these are always `geom_smooth(method = glm)`


Things I'm not sure about:

> In subsequent analyses, we estimated the predator-prey habitat domain spatially as the interaction between the predator and prey habitat domains

We don't actually *spatially* interact the predator and prey domains right? How could we do this? Correlation of rasters? Difference between predator - prey RSF values?



## Setup 
```{r}
pkgs <- c('data.table', 'ggplot2', 'patchwork')
p <- suppressPackageStartupMessages(lapply(
  pkgs, 
  library, 
  character.only = TRUE)
)
```


## Data

```{r}
caribou <- readRDS('output/4-sociality/caribouNNA-ALR.Rds')
elk <- readRDS('output/4-sociality/elkNNA-ALR.Rds')

coordCols <- c('EASTING', 'NORTHING')
idCol <- 'id'

caribou[, species := 'caribou']
elk[, species := 'elk']

DT <- rbindlist(list(caribou, elk), fill = TRUE)
```

A note regarding differences between this and the sociality models R scripts: I've combined the caribou and elk data into a global `DT`. Downstream I've added `by = species` wherever necessary. 


## Variables

### Scaled RSF

Shouldn't this scaling be seasonal?


```{r}
DT[, z.avgpreyRSF := scale(avgpreyRSF, center = T, scale = T)]
DT[, z.avgpredatorRSF := scale(avgpredatorRSF, center = T, scale = T)]

# By species*seasonal 
DT[, z.avgpreyRSFBy := scale(avgpreyRSF, center = T, scale = T), .(species, season)]
DT[, z.avgpredatorRSFBy := scale(avgpredatorRSF, center = T, scale = T), .(species, season)]

```


Isn't this the second time scaling is performed? We scaled the global RSFs, then rescaled within the sampled points?

In scripts `NL-RSF.R` and `RMNP-RSF.R`:

```
### Rescale RSFs ----
q <- 0.999

winterQ <- quantile(winterCrop, q)
winterCrop[winterCrop > winterQ] <- winterQ

winterScaled <-
  (winterCrop - (cellStats(winterCrop, min))) /
  (quantile(winterCrop, q) - (cellStats(winterCrop, min)))

springQ <- quantile(springCrop, q)
springCrop[springCrop > springQ] <- springQ

springScaled <-
  (springCrop - (cellStats(springCrop, min))) /
  (cellStats(springCrop, max) - (cellStats(springCrop, min)))
```


### Bin 500m
```{r}
# Dyads within 500m 
setnames(DT, 'distance', 'dyadDist')
DT[dyadDist >= 500, bin500m := TRUE]
DT[dyadDist < 500, bin500m := FALSE]
```


> "The DI approach, as in Cr,  measures  cohesiveness  irrespective  of  proximity between corresponding movement vectors (Table 2). Thus, to justify DI analysis, the researcher is required to havesomea prioriexpectation of cohesive movement, which, for example, can be based on proximity (defined by distance threshold dc), a measure of static interaction (e.g.home range overlap) or simultaneous capture (e.g. familial groups). DI can then be set to 0 when these conditions are not met"

From: A critical examination of indices of dynamic interaction for wildlife telemetry studies


Is there a value less than 500m, relevant for setting DI to 0? Is 500m relevant for both elk and caribou?


```{r}

# Set DI to 0 if > 500m between dyads
DT[dyadDist >= 500, di0 := 0]
DT[dyadDist < 500, di0 := di]
```


### Drop duplicated dyads
```{r}
# Drop duplicated dyads (won't be exactly half 
#   the number of rows because not all NN are NN with each other)
DT <- unique(DT[!is.na(NN)], by = c('dyadID', 'timegroup'))
```



### Global DI
Seems to me that global DI should likely be calculated for the full dataset, before subsetting because it is relevant for dyads that are not observed within 500m often

```{r}
DT[, globalDI := mean(di0), .(season, dyadID)]
DT[, globalDIAngle := mean(diAngle), .(season, dyadID)]
DT[, globalDIDist := mean(diDist), .(season, dyadID)]
```

### Global average RSF
If we summarize dyads to a single value, we need a similar resolution RSF value

```{r}
DT[, globavgpredatorRSF := mean(avgpredatorRSF), .(season, dyadID)]
DT[, globavgpreyRSF := mean(avgpreyRSF), .(season, dyadID)]
```


### Subset
```{r}
DTsoc <- DT[dyadDist < 50]
```


\newpage

## Plots
Relationship between difference in RSF and distance within dyad

```{r, fig.height = 6}
# Dist vs diff in RSF
g1 <- ggplot(DTsoc, aes(dyadDist, dpreyRSF)) +
  geom_point(color = 'black', alpha = 0.5) +
  geom_smooth(method = glm)

g2 <- ggplot(DTsoc, aes(dyadDist, dpredatorRSF)) +
  geom_point(color = 'black', alpha = 0.5) +
  geom_smooth(method = glm)

g1 / g2 
```


\newpage

Relationship between DI and distance within dyad

*Note: DI is not affected by distance of dyads, but this is interesting to see if there's any influence*


```{r, fig.height = 6}
# Dist vs DI
g1 <- ggplot(DTsoc, aes(dyadDist, di)) +
  geom_point(color = 'black', alpha = 0.5) + geom_smooth(method = glm)

g2 <- ggplot(DTsoc, aes(di)) +
  geom_histogram() + geom_vline(aes(xintercept = 0.8), color = 'red') +
  labs(subtitle = 'chunks by interval dyad distance from 0-500')

g3 <- g2 + facet_wrap(~ cut_number(dyadDist, 4)) + labs(subtitle = 'chunks by number/equal count in each chunk')
g2 <- g2 + facet_wrap(~ cut_interval(dyadDist, 4))

g1 / g2 / g3
```


\newpage

Relationship between DI and distance within dyad *by species*


```{r, fig.height = 6}
# Dist vs DI
g1 <- ggplot(DTsoc, aes(dyadDist, di)) +
  geom_point(color = 'black', alpha = 0.5) + geom_smooth(method = glm)+
  facet_wrap(~species)

g2 <- ggplot(DTsoc, aes(di)) +
  geom_histogram() + geom_vline(aes(xintercept = 0.8), color = 'red') +
  labs(subtitle = 'chunks by interval dyad distance from 0-500')

g3 <- g2 + facet_grid(species~ cut_number(dyadDist, 4), scales = 'free_y') + labs(subtitle = 'chunks by number/equal count in each chunk')
g2 <- g2 + facet_grid(species ~ cut_interval(dyadDist, 4), scales = 'free_y')

g1 / g2 / g3
```

\newpage

Relationship between average predator RSF and average prey RSF

```{r}
### Plots ----
g1 <- ggplot(DTsoc[species == 'caribou'], aes(avgpreyRSF, avgpredatorRSF)) + 
  geom_point(color = 'grey') + 
  geom_smooth(method = glm) + 
  ggtitle('caribou')

g2 <- ggplot(DTsoc[species == 'caribou'], aes(avgpreyRSF, avgcoyoteRSF)) + 
  geom_point(color = 'grey') + geom_smooth(method = glm)

g3 <- ggplot(DTsoc[species == 'caribou'], aes(avgpreyRSF, avgbearRSF)) + 
  geom_point(color = 'grey')  + geom_smooth(method = glm)

g4 <- ggplot(DTsoc[species == 'elk'], aes(avgpreyRSF, avgpredatorRSF)) + 
  geom_point(color = 'grey') +  geom_smooth(method = glm) + ggtitle('elk')

layout <- c('AD
             B#
             CE')
```

\newpage

```{r, warning = FALSE, fig.height = 12, fig.width = 11}
(g1 + g2 + g3 + g4 & facet_grid(~ season)) + guide_area() +
  plot_layout(design = layout, guides = 'collect') 
```



\newpage


Relationship between DI and predator RSF

```{r, fig.height = 10, fig.width = 9}
g1 <- ggplot(DTsoc, aes(avgpredatorRSF, di)) 
g2 <- ggplot(DTsoc, aes(avgpredatorRSF, diAngle)) 
g3 <- ggplot(DTsoc, aes(avgpredatorRSF, diDist))

g1 / g2 / g3 & geom_point(color = 'grey') &
  facet_grid(season ~ species) &
  geom_smooth(method = glm)
```


\newpage

Relationship between DI and prey RSF

```{r, fig.height = 10, fig.width = 9}
g1 <- ggplot(DTsoc, aes(avgpreyRSF, di)) 
g2 <- ggplot(DTsoc, aes(avgpreyRSF, diAngle)) 
g3 <- ggplot(DTsoc, aes(avgpreyRSF, diDist))

g1 / g2 / g3 & geom_point(color = 'grey') &
  facet_grid(season ~ species) &
  geom_smooth(method = glm)
```

\newpage

Relationship between global DI and global average predator RSF

```{r, fig.height = 10, fig.width = 9}
g1 <- ggplot(DTsoc, aes(globavgpredatorRSF, di)) 
g2 <- ggplot(DTsoc, aes(globavgpredatorRSF, diAngle)) 
g3 <- ggplot(DTsoc, aes(globavgpredatorRSF, diDist))

g1 / g2 / g3 & geom_point(color = 'grey') &
  facet_grid(season ~ species) &
  geom_smooth(method = glm)
```

\newpage

Relationship between global DI and global average prey RSF

```{r, fig.height = 10, fig.width = 9}
g1 <- ggplot(DTsoc, aes(globavgpreyRSF, di)) 
g2 <- ggplot(DTsoc, aes(globavgpreyRSF, diAngle)) 
g3 <- ggplot(DTsoc, aes(globavgpreyRSF, diDist))

g1 / g2 / g3 & geom_point(color = 'grey') &
  facet_grid(season ~ species) &
  geom_smooth(method = glm)
```

\newpage

## Spatially explicit predator:prey domain

```{r}
# Attempts at pred:prey domain
DTsoc[, predpreyRSF := predatorRSF - preyRSF]
DTsoc[, predpreyRSF.nn := predatorRSF.nn - preyRSF.nn]
```